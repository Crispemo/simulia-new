const nodemailer = require('nodemailer');

// Verificar si las credenciales de email est√°n configuradas
const hasEmailCredentials = process.env.EMAIL && process.env.EMAIL_PASSWORD;

// Log de diagn√≥stico para producci√≥n
console.log('=== DIAGN√ìSTICO EMAIL SERVICE ===');
console.log('EMAIL configurado:', !!process.env.EMAIL);
console.log('EMAIL_PASSWORD configurado:', !!process.env.EMAIL_PASSWORD);
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('================================');

// Configura el transporte de correo solo si las credenciales est√°n disponibles
let transporter = null;

if (hasEmailCredentials) {
  transporter = nodemailer.createTransport({
    host: 'smtp.gmail.com',
    port: 587,
    secure: false, // true para 465, false para otros puertos
    auth: {
      user: process.env.EMAIL,
      pass: process.env.EMAIL_PASSWORD,
    },
    // Configuraciones de timeout m√°s agresivas
    connectionTimeout: 10000, // 10 segundos
    greetingTimeout: 5000,    // 5 segundos
    socketTimeout: 10000,     // 10 segundos
    // Configuraciones adicionales para mejorar la estabilidad
    pool: false,
    maxConnections: 1,
    maxMessages: 1,
    rateLimit: 1,
    // Configuraciones TLS
    tls: {
      rejectUnauthorized: false,
      ciphers: 'SSLv3'
    }
  });
  
  // Verificar la configuraci√≥n de email al inicializar (con timeout)
  const verifyTimeout = setTimeout(() => {
    console.log('‚ö†Ô∏è  Timeout en verificaci√≥n de email, pero el transporter sigue activo');
  }, 10000); // 10 segundos timeout

  transporter.verify((error, success) => {
    clearTimeout(verifyTimeout);
    if (error) {
      console.error('Error en la configuraci√≥n de email:', error.message);
      // NO deshabilitar el transporter aqu√≠, solo loguear el error
      console.log('‚ö†Ô∏è  Advertencia: Error en verificaci√≥n de email, pero el transporter sigue activo');
    } else {
      console.log('‚úÖ Servicio de email configurado correctamente');
    }
  });
} else {
  console.log('Variables de email no configuradas. Funcionando en modo desarrollo sin email.');
}

// Funci√≥n para enviar correos personalizados
const sendSubscriptionEmail = async (email, plan, expirationDate) => {
  if (!email || !plan) {
    console.error('Faltan datos para enviar el correo (email o plan).');
    return;
  }

  let subject = 'Confirmaci√≥n de suscripci√≥n';
  let content = 'Gracias por tu suscripci√≥n.';

  switch (plan) {
    case 'mensual':
      subject = 'Gracias por elegir el plan mensual';
      content = `
      <h1>Bienvenido a Simulia</h1>
      <p>¬°Gracias por suscribirte al plan mensual! Tu suscripci√≥n expira el ${expirationDate.toLocaleDateString()}.
      <br>Puedes acceder a todas las funciones de la plataforma durante este per√≠odo.</p>
      <p>Si tienes alguna pregunta, no dudes en contactarnos a simuliaproject@simulia.es</p>
      `;
      break;
    case 'anual':
      subject = 'Gracias por elegir el plan anual';
      content = `
      <h1>Bienvenido a Simulia</h1>
      <p>¬°Gracias por suscribirte al plan anual! Tu suscripci√≥n expira el ${expirationDate.toLocaleDateString()}.
      <br>Has elegido la mejor opci√≥n para prepararte a fondo.</p>
      <p>Si tienes alguna pregunta, no dudes en contactarnos a simuliaproject@simulia.es</p>
      `;
      break;
    default:
      // No har√≠a falta, pero por si acaso
      subject = 'Confirmaci√≥n de suscripci√≥n a Simulia';
      content = `
      <h1>Bienvenido a Simulia</h1>
      <p>Gracias por suscribirte. Tu cuenta estar√° activa hasta el ${expirationDate.toLocaleDateString()}.</p>
      <p>Si tienes alguna pregunta, no dudes en contactarnos a simuliaproject@simulia.es</p>
      `;
  }

  // Si no hay transporter configurado, solo loguear
  if (!transporter) {
    console.log('=== EMAIL SIMULADO (Sin configuraci√≥n de email) ===');
    console.log(`Para: ${email}`);
    console.log(`Asunto: ${subject}`);
    console.log(`Contenido: ${content}`);
    console.log('================================================');
    return true; // Simular √©xito
  }

  // Funci√≥n para reintentar el env√≠o de email
  const sendWithRetry = async (mailOptions, maxRetries = 3) => {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        await transporter.sendMail(mailOptions);
        console.log(`‚úÖ Correo enviado a ${email} (intento ${attempt})`);
        return true;
      } catch (error) {
        console.error(`‚ùå Error al enviar correo (intento ${attempt}/${maxRetries}):`, error.message);
        
        // Si es el √∫ltimo intento, devolver false
        if (attempt === maxRetries) {
          console.error(`üí• Fall√≥ el env√≠o de correo despu√©s de ${maxRetries} intentos`);
          return false;
        }
        
        // Esperar antes del siguiente intento (backoff exponencial)
        const delay = Math.pow(2, attempt) * 1000; // 2s, 4s, 8s...
        console.log(`‚è≥ Esperando ${delay}ms antes del siguiente intento...`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
    return false;
  };

  try {
    const mailOptions = {
      from: process.env.EMAIL,
      to: email,
      subject,
      html: content,
    };
    
    return await sendWithRetry(mailOptions);
  } catch (error) {
    console.error('Error cr√≠tico al enviar correo:', error.message);
    return false;
  }
};

// Funci√≥n para enviar impugnaciones
const sendDisputeEmail = async (question, reason, userAnswer, userEmail, userId) => {
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üìß INICIO ENV√çO IMPUGNACI√ìN - LOGS DETALLADOS');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('‚è∞ Timestamp:', new Date().toISOString());
  console.log('üåç Environment:', process.env.NODE_ENV || 'development');
  console.log('üìç Platform:', process.platform);
  console.log('üîß Node Version:', process.version);
  
  if (!question) {
    console.error('‚ùå ERROR: Faltan datos para enviar la impugnaci√≥n (pregunta).');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    return false;
  }

  const subject = 'impugnaci√≥n';
  const message = `
    Se ha recibido una nueva impugnaci√≥n:
    
    Usuario: ${userId || 'No disponible'}
    Email: ${userEmail || 'No disponible'}
    
    Pregunta: ${question}
    
    Respuesta seleccionada: ${userAnswer || 'No seleccionada'}
    
    Raz√≥n de impugnaci√≥n: ${reason || 'No especificada'}
    
    Fecha: ${new Date().toLocaleString()}
  `;

  // Logs detallados de configuraci√≥n
  console.log('üìã CONFIGURACI√ìN DE EMAIL:');
  console.log('  - EMAIL existe:', !!process.env.EMAIL);
  console.log('  - EMAIL value:', process.env.EMAIL ? `${process.env.EMAIL.substring(0, 3)}***` : 'NO CONFIGURADO');
  console.log('  - EMAIL_PASSWORD existe:', !!process.env.EMAIL_PASSWORD);
  console.log('  - EMAIL_PASSWORD length:', process.env.EMAIL_PASSWORD ? process.env.EMAIL_PASSWORD.length : 0);
  console.log('  - Transporter inicializado:', !!transporter);

  // Si no hay transporter configurado, solo loguear la impugnaci√≥n
  if (!transporter) {
    console.log('‚ö†Ô∏è  ADVERTENCIA: No hay transporter configurado');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üìù IMPUGNACI√ìN RECIBIDA (Sin configuraci√≥n de email)');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('‚ö†Ô∏è  PROBLEMA: Las credenciales de email no est√°n configuradas en producci√≥n');
    console.log(`üë§ Usuario ID: ${userId || 'No disponible'}`);
    console.log(`üìß Email: ${userEmail || 'No disponible'}`);
    console.log(`‚ùì Pregunta: ${question.substring(0, 100)}...`);
    console.log(`‚úçÔ∏è  Respuesta seleccionada: ${userAnswer || 'No seleccionada'}`);
    console.log(`üí≠ Raz√≥n: ${reason || 'No especificada'}`);
    console.log(`üìÖ Fecha: ${new Date().toLocaleString()}`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    return true; // Simular √©xito para que el frontend no muestre error
  }

  // Funci√≥n para reintentar el env√≠o de email de impugnaci√≥n
  const sendDisputeWithRetry = async (mailOptions, maxRetries = 2) => {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      console.log(`üîÑ INTENTO ${attempt}/${maxRetries} - Enviando email`);
      console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      
      try {
        console.log('üîß Creando nuevo transporter...');
        console.log('üìã Configuraci√≥n SMTP:');
        console.log('  - Host: smtp.gmail.com');
        console.log('  - Port: 587');
        console.log('  - Secure: false');
        console.log('  - Auth User:', process.env.EMAIL ? `${process.env.EMAIL.substring(0, 3)}***` : 'NO CONFIGURADO');
        console.log('  - Connection Timeout: 10000ms');
        console.log('  - Greeting Timeout: 5000ms');
        console.log('  - Socket Timeout: 10000ms');
        console.log('  - TLS Min Version: TLSv1.2');
        
        // Crear un nuevo transporter para cada intento para evitar problemas de conexi√≥n
        const freshTransporter = nodemailer.createTransport({
          host: 'smtp.gmail.com',
          port: 587,
          secure: false,
          auth: {
            user: process.env.EMAIL,
            pass: process.env.EMAIL_PASSWORD,
          },
          connectionTimeout: 10000, // 10 segundos (aumentado)
          greetingTimeout: 5000,    // 5 segundos (aumentado)
          socketTimeout: 10000,     // 10 segundos (aumentado)
          tls: {
            rejectUnauthorized: false,
            minVersion: 'TLSv1.2'
          },
          debug: true, // Habilitar debug de nodemailer
          logger: true, // Habilitar logger de nodemailer
          pool: false,
          direct: false
        });
        
        console.log('‚úÖ Transporter creado exitosamente');
        console.log('üì§ Opciones del email:');
        console.log('  - From:', mailOptions.from);
        console.log('  - To:', mailOptions.to);
        console.log('  - Subject:', mailOptions.subject);
        console.log('  - Text length:', mailOptions.text ? mailOptions.text.length : 0);
        
        console.log('üì° Iniciando env√≠o de email...');
        const startTime = Date.now();
        
        const info = await freshTransporter.sendMail(mailOptions);
        
        const endTime = Date.now();
        const duration = endTime - startTime;
        
        console.log('‚úÖ‚úÖ‚úÖ √âXITO: Correo de impugnaci√≥n enviado');
        console.log('üìä Informaci√≥n del env√≠o:');
        console.log('  - MessageId:', info.messageId);
        console.log('  - Response:', info.response);
        console.log('  - Accepted:', info.accepted);
        console.log('  - Rejected:', info.rejected);
        console.log('  - Duraci√≥n:', duration, 'ms');
        console.log(`  - Intento: ${attempt}/${maxRetries}`);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        return true;
      } catch (error) {
        const errorTime = Date.now();
        console.error('‚ùå‚ùå‚ùå ERROR al enviar correo de impugnaci√≥n');
        console.error('üîç DETALLES COMPLETOS DEL ERROR:');
        console.error('  - Intento:', `${attempt}/${maxRetries}`);
        console.error('  - Error Name:', error.name);
        console.error('  - Error Message:', error.message);
        console.error('  - Error Code:', error.code);
        console.error('  - Error Command:', error.command);
        console.error('  - Response Code:', error.responseCode);
        console.error('  - Response:', error.response);
        console.error('  - Timestamp:', new Date(errorTime).toISOString());
        
        // Log del stack trace completo
        if (error.stack) {
          console.error('üìö Stack Trace:');
          console.error(error.stack);
        }
        
        // Log de propiedades adicionales del error
        console.error('üîç Propiedades del error:');
        console.error('  - All Properties:', Object.keys(error));
        for (const key in error) {
          if (error.hasOwnProperty(key) && !['stack', 'name', 'message'].includes(key)) {
            console.error(`  - ${key}:`, error[key]);
          }
        }
        
        // Si es el √∫ltimo intento, devolver false
        if (attempt === maxRetries) {
          console.error('üí•üí•üí• FALLO FINAL: Agotados todos los intentos');
          console.error(`  - Total de intentos: ${maxRetries}`);
          console.error('  - √öltimo error:', error.message);
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          return false;
        }
        
        // Esperar menos tiempo entre intentos
        const delay = 1000; // 1 segundo
        console.log(`‚è≥ Esperando ${delay}ms antes del siguiente intento...`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
    return false;
  };

  try {
    const mailOptions = {
      from: process.env.EMAIL,
      to: 'simuliaproject@simulia.es', // Se env√≠a al correo de impugnaciones
      subject,
      text: message,
    };
    
    console.log('üöÄ Iniciando proceso de env√≠o con reintentos...');
    const result = await sendDisputeWithRetry(mailOptions);
    console.log('üèÅ Proceso finalizado. Resultado:', result ? '√âXITO' : 'FALLO');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    return result;
  } catch (error) {
    console.error('üí• ERROR CR√çTICO al enviar correo de impugnaci√≥n');
    console.error('üîç Detalles del error cr√≠tico:');
    console.error('  - Name:', error.name);
    console.error('  - Message:', error.message);
    console.error('  - Stack:', error.stack);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    return false;
  }
};

module.exports = { sendSubscriptionEmail, sendDisputeEmail };